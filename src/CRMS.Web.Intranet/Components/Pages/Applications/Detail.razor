@page "/applications/{Id:guid}"
@using CRMS.Web.Intranet.Components.Pages.Applications.Modals
@inject ApplicationService AppService
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>@(application?.ApplicationNumber ?? "Application") - CRMS</PageTitle>

@if (isLoading)
{
    <div class="card p-6 text-center">
        <div class="spinner" style="margin: 0 auto;"></div>
        <p class="text-muted mt-4">Loading application...</p>
    </div>
}
else if (application == null)
{
    <div class="card">
        <div class="empty-state">
            <div class="empty-state-icon">
                <span class="material-symbols-outlined">error</span>
            </div>
            <div class="empty-state-title">Application not found</div>
            <div class="empty-state-text">The application you're looking for doesn't exist or you don't have permission to view it.</div>
            <a href="/applications" class="btn btn-primary">Back to Applications</a>
        </div>
    </div>
}
else
{
    <div class="page-header">
        <div style="display: flex; align-items: center; gap: var(--space-4);">
            <button class="btn btn-ghost" @onclick="GoBack">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <div>
                <div style="display: flex; align-items: center; gap: var(--space-3);">
                    <h1 class="page-title">@application.ApplicationNumber</h1>
                    <span class="badge @GetStatusBadgeClass(application.Status)" style="font-size: var(--text-sm);">
                        @FormatStatus(application.Status)
                    </span>
                </div>
                <p class="page-subtitle">@application.Customer.CompanyName</p>
            </div>
        </div>
        <div style="display: flex; gap: var(--space-3);">
            @if (ShowSubmitForReviewButton)
            {
                <button class="btn btn-primary" @onclick="ShowSubmitForReviewModal" disabled="@isSubmittingForReview">
                    @if (isSubmittingForReview)
                    {
                        <span class="spinner"></span>
                    }
                    else
                    {
                        <span class="material-symbols-outlined" style="font-size: 18px;">send</span>
                    }
                    Submit for Review
                </button>
            }
            @if (CanGeneratePack)
            {
                <button class="btn btn-outline" @onclick="GenerateLoanPack" disabled="@isGeneratingPack">
                    @if (isGeneratingPack)
                    {
                        <span class="spinner"></span>
                    }
                    else
                    {
                        <span class="material-symbols-outlined" style="font-size: 18px;">picture_as_pdf</span>
                    }
                    Loan Pack
                </button>
            }
            @if (ShowApproveButton)
            {
                <button class="btn btn-success" @onclick="() => ShowActionModal(ActionType.Approve)">
                    <span class="material-symbols-outlined" style="font-size: 18px;">check</span>
                    Approve
                </button>
            }
            @if (ShowReturnButton)
            {
                <button class="btn btn-secondary" @onclick="() => ShowActionModal(ActionType.Return)">
                    <span class="material-symbols-outlined" style="font-size: 18px;">undo</span>
                    Return
                </button>
            }
            @if (ShowRejectButton)
            {
                <button class="btn btn-danger" @onclick="() => ShowActionModal(ActionType.Reject)">
                    <span class="material-symbols-outlined" style="font-size: 18px;">close</span>
                    Reject
                </button>
            }
        </div>
    </div>

    <div class="card mb-6">
        <div class="card-body" style="padding: var(--space-4) var(--space-6);">
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: var(--space-6);">
                <div>
                    <div style="font-size: var(--text-xs); color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.05em;">Product</div>
                    <div style="font-weight: 500; margin-top: var(--space-1);">@application.Loan.ProductName</div>
                </div>
                <div>
                    <div style="font-size: var(--text-xs); color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.05em;">Requested Amount</div>
                    <div style="font-weight: 600; margin-top: var(--space-1); color: var(--primary-600);">@FormatCurrency(application.Loan.RequestedAmount)</div>
                </div>
                <div>
                    <div style="font-size: var(--text-xs); color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.05em;">Tenor</div>
                    <div style="font-weight: 500; margin-top: var(--space-1);">@application.Loan.TenorMonths months</div>
                </div>
                <div>
                    <div style="font-size: var(--text-xs); color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.05em;">Interest Rate</div>
                    <div style="font-weight: 500; margin-top: var(--space-1);">@application.Loan.InterestRate% @application.Loan.InterestRateType</div>
                </div>
                <div>
                    <div style="font-size: var(--text-xs); color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.05em;">Created</div>
                    <div style="font-weight: 500; margin-top: var(--space-1);">@application.CreatedAt.ToString("MMM dd, yyyy")</div>
                </div>
            </div>
        </div>
    </div>

    <div class="tabs">
        <div class="tab @(activeTab == "overview" ? "active" : "")" @onclick='() => activeTab = "overview"'>Overview</div>
        <div class="tab @(activeTab == "parties" ? "active" : "")" @onclick='() => activeTab = "parties"'>Directors & Signatories</div>
        <div class="tab @(activeTab == "documents" ? "active" : "")" @onclick='() => activeTab = "documents"'>Documents</div>
        <div class="tab @(activeTab == "financials" ? "active" : "")" @onclick='() => activeTab = "financials"'>Financial Analysis</div>
        <div class="tab @(activeTab == "bureau" ? "active" : "")" @onclick='() => activeTab = "bureau"'>Credit Bureau</div>
        <div class="tab @(activeTab == "collateral" ? "active" : "")" @onclick='() => activeTab = "collateral"'>Collateral</div>
        <div class="tab @(activeTab == "guarantors" ? "active" : "")" @onclick='() => activeTab = "guarantors"'>Guarantors</div>
        <div class="tab @(activeTab == "advisory" ? "active" : "")" @onclick='() => activeTab = "advisory"'>AI Advisory</div>
        <div class="tab @(activeTab == "workflow" ? "active" : "")" @onclick='() => activeTab = "workflow"'>Workflow</div>
        <div class="tab @(activeTab == "committee" ? "active" : "")" @onclick='() => activeTab = "committee"'>Committee</div>
        <div class="tab @(activeTab == "comments" ? "active" : "")" @onclick='() => activeTab = "comments"'>Comments</div>
    </div>

    @switch (activeTab)
    {
        case "overview":
            <OverviewTab Application="application" />
            break;
        case "parties":
            <PartiesTab Directors="application.Directors" Signatories="application.Signatories" OnRequestBureauCheck="RequestBureauCheck" />
            break;
        case "documents":
            <DocumentsTab
                Documents="application.Documents"
                IsEditable="IsApplicationEditable"
                OnUploadDocument="ShowUploadDocumentModal"
                OnVerifyDocument="VerifyDocument"
                OnRejectDocument="ShowRejectDocumentModal" />
            break;
        case "financials":
            <FinancialsTab 
                Analysis="application.FinancialAnalysis" 
                Statements="application.FinancialStatements"
                IncorporationDate="application.Customer.IncorporationDate"
                IsEditable="IsApplicationEditable"
                OnEnterFinancials="ShowFinancialStatementModal"
                OnUploadExcel="ShowExcelUploadModal"
                OnViewStatement="ViewFinancialStatement"
                OnEditStatement="EditFinancialStatement"
                OnDeleteStatement="DeleteFinancialStatement"
                OnDeleteAll="DeleteAllFinancialStatements" />
            break;
        case "bureau":
            <BureauTab Reports="application.BureauReports" />
            break;
        case "collateral":
            <CollateralTab
                Collaterals="application.Collaterals"
                IsEditable="IsApplicationEditable"
                CanManageValuation="CanManageValuation"
                OnAddCollateral="ShowAddCollateralModal"
                OnViewCollateral="ViewCollateral"
                OnEditCollateral="EditCollateral"
                OnDeleteCollateral="DeleteCollateral"
                OnSetValuation="ShowSetValuationModal"
                OnApproveCollateral="ShowApproveCollateralModal"
                OnUploadDocument="ShowUploadCollateralDocModal" />
            break;
        case "guarantors":
            <GuarantorsTab 
                Guarantors="application.Guarantors" 
                IsEditable="IsApplicationEditable"
                CanManageGuarantors="CanManageGuarantors"
                OnAddGuarantor="ShowAddGuarantorModal"
                OnViewGuarantor="ViewGuarantor"
                OnEditGuarantor="EditGuarantor"
                OnDeleteGuarantor="DeleteGuarantor"
                OnApproveGuarantor="ShowApproveGuarantorModal"
                OnRejectGuarantor="ShowRejectGuarantorModal" />
            break;
        case "advisory":
            <AdvisoryTab Advisory="application.Advisory" OnGenerateAdvisory="GenerateAdvisory" />
            break;
        case "workflow":
            <WorkflowTab History="application.WorkflowHistory" CurrentStatus="application.Status" />
            break;
        case "committee":
            <CommitteeTab Committee="application.Committee" OnCastVote="CastVote" />
            break;
        case "comments":
            <CommentsTab Comments="application.Comments" OnAddComment="AddComment" />
            break;
    }
}

@if (showActionModal)
{
    <div class="modal-backdrop show" @onclick="CloseActionModal">
        <div class="modal" @onclick:stopPropagation>
            <div class="modal-header">
                <h3 class="modal-title">@GetActionTitle()</h3>
                <button class="modal-close" @onclick="CloseActionModal">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Comments @(currentAction == ActionType.Approve ? "(Optional)" : "(Required)")</label>
                    <textarea class="form-control" rows="4" @bind="actionComments" placeholder="Enter your comments..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseActionModal">Cancel</button>
                <button class="btn @GetActionButtonClass()" @onclick="ExecuteAction" disabled="@isExecutingAction">
                    @if (isExecutingAction)
                    {
                        <span class="spinner"></span>
                    }
                    @GetActionButtonText()
                </button>
            </div>
        </div>
    </div>
}

@if (showCollateralModal)
{
    <AddCollateralModal 
        ApplicationId="Id" 
        OnClose="CloseCollateralModal" 
        OnSuccess="OnCollateralAdded" />
}

@if (showViewCollateralModal && viewingCollateralId.HasValue)
{
    <ViewCollateralModal 
        CollateralId="viewingCollateralId.Value"
        CanDelete="IsApplicationEditable || CanManageValuation"
        OnClose="CloseViewCollateralModal"
        OnDocumentDeleted="OnCollateralDocumentDeleted" />
}

@if (showEditCollateralModal && editingCollateralId.HasValue)
{
    <EditCollateralModal
        CollateralId="editingCollateralId.Value"
        OnClose="CloseEditCollateralModal"
        OnSuccess="OnCollateralUpdated" />
}

@if (showSetValuationModal && valuatingCollateralId.HasValue)
{
    <SetCollateralValuationModal
        CollateralId="valuatingCollateralId.Value"
        OnClose="CloseSetValuationModal"
        OnSuccess="OnCollateralValuated" />
}

@if (showApproveCollateralModal && approvingCollateralId.HasValue)
{
    var collateralToApprove = application?.Collaterals.FirstOrDefault(c => c.Id == approvingCollateralId.Value);
    <div class="modal-backdrop show" @onclick="CloseApproveCollateralModal">
        <div class="modal" style="max-width: 450px;" @onclick:stopPropagation>
            <div class="modal-header">
                <h3 class="modal-title">
                    <span class="material-symbols-outlined" style="font-size: 22px; vertical-align: middle; margin-right: var(--space-2); color: var(--success-600);">check_circle</span>
                    Approve Collateral
                </h3>
                <button class="modal-close" @onclick="CloseApproveCollateralModal">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Approve the collateral: <strong>@(collateralToApprove?.Description ?? "this item")</strong>?</p>
                <p class="text-muted" style="font-size: var(--text-sm);">This will mark the collateral as approved and eligible to secure the loan facility.</p>
                @if (!string.IsNullOrEmpty(approveCollateralError))
                {
                    <div class="alert alert-danger mt-3" style="display: flex; gap: var(--space-2); align-items: flex-start;">
                        <span class="material-symbols-outlined" style="color: var(--danger-600); font-size: 18px;">error</span>
                        <span>@approveCollateralError</span>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" @onclick="CloseApproveCollateralModal" disabled="@isApprovingCollateral">Cancel</button>
                <button type="button" class="btn btn-success" @onclick="ConfirmApproveCollateral" disabled="@isApprovingCollateral">
                    @if (isApprovingCollateral)
                    {
                        <span class="material-symbols-outlined spinning" style="font-size: 18px;">sync</span>
                        <span>Approving...</span>
                    }
                    else
                    {
                        <span class="material-symbols-outlined" style="font-size: 18px;">check_circle</span>
                        <span>Approve Collateral</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

@if (showUploadCollateralDocModal && uploadingCollateralDocId.HasValue)
{
    <UploadCollateralDocumentModal
        CollateralId="uploadingCollateralDocId.Value"
        OnClose="CloseUploadCollateralDocModal"
        OnSuccess="OnCollateralDocUploaded" />
}

@if (showGuarantorModal)
{
    <AddGuarantorModal 
        ApplicationId="Id" 
        OnClose="CloseGuarantorModal" 
        OnSuccess="OnGuarantorAdded" />
}

@if (showViewGuarantorModal && viewingGuarantorId.HasValue)
{
    <ViewGuarantorModal 
        GuarantorId="viewingGuarantorId.Value" 
        OnClose="CloseViewGuarantorModal" />
}

@if (showEditGuarantorModal && editingGuarantorId.HasValue)
{
    <EditGuarantorModal 
        GuarantorId="editingGuarantorId.Value" 
        OnClose="CloseEditGuarantorModal" 
        OnSuccess="OnGuarantorUpdated" />
}

@if (showDeleteCollateralModal && deletingCollateralId.HasValue)
{
    var collateralToDelete = application?.Collaterals.FirstOrDefault(c => c.Id == deletingCollateralId.Value);
    <div class="modal-backdrop show" @onclick="CloseDeleteCollateralModal">
        <div class="modal" style="max-width: 450px;" @onclick:stopPropagation>
            <div class="modal-header">
                <h3 class="modal-title" style="color: var(--danger-600);">
                    <span class="material-symbols-outlined" style="font-size: 24px; vertical-align: middle; margin-right: var(--space-2);">warning</span>
                    Delete Collateral
                </h3>
                <button class="modal-close" @onclick="CloseDeleteCollateralModal">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the collateral: <strong>@(collateralToDelete?.Description ?? "this item")</strong>?</p>
                <p class="text-muted" style="font-size: var(--text-sm);">This action cannot be undone.</p>
                @if (!string.IsNullOrEmpty(deleteErrorMessage))
                {
                    <div class="alert alert-danger mt-3" style="display: flex; gap: var(--space-2); align-items: flex-start;">
                        <span class="material-symbols-outlined" style="color: var(--danger-600); font-size: 18px;">error</span>
                        <span>@deleteErrorMessage</span>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" @onclick="CloseDeleteCollateralModal" disabled="@isDeleting">Cancel</button>
                <button type="button" class="btn btn-danger" @onclick="ConfirmDeleteCollateral" disabled="@isDeleting">
                    @if (isDeleting)
                    {
                        <span class="material-symbols-outlined spinning" style="font-size: 18px;">sync</span>
                        <span>Deleting...</span>
                    }
                    else
                    {
                        <span class="material-symbols-outlined" style="font-size: 18px;">delete</span>
                        <span>Delete</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

@if (showDeleteGuarantorModal && deletingGuarantorId.HasValue)
{
    var guarantorToDelete = application?.Guarantors.FirstOrDefault(g => g.Id == deletingGuarantorId.Value);
    <div class="modal-backdrop show" @onclick="CloseDeleteGuarantorModal">
        <div class="modal" style="max-width: 450px;" @onclick:stopPropagation>
            <div class="modal-header">
                <h3 class="modal-title" style="color: var(--danger-600);">
                    <span class="material-symbols-outlined" style="font-size: 24px; vertical-align: middle; margin-right: var(--space-2);">warning</span>
                    Delete Guarantor
                </h3>
                <button class="modal-close" @onclick="CloseDeleteGuarantorModal">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the guarantor: <strong>@(guarantorToDelete?.Name ?? "this item")</strong>?</p>
                <p class="text-muted" style="font-size: var(--text-sm);">This action cannot be undone.</p>
                @if (!string.IsNullOrEmpty(deleteErrorMessage))
                {
                    <div class="alert alert-danger mt-3" style="display: flex; gap: var(--space-2); align-items: flex-start;">
                        <span class="material-symbols-outlined" style="color: var(--danger-600); font-size: 18px;">error</span>
                        <span>@deleteErrorMessage</span>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" @onclick="CloseDeleteGuarantorModal" disabled="@isDeleting">Cancel</button>
                <button type="button" class="btn btn-danger" @onclick="ConfirmDeleteGuarantor" disabled="@isDeleting">
                    @if (isDeleting)
                    {
                        <span class="material-symbols-outlined spinning" style="font-size: 18px;">sync</span>
                        <span>Deleting...</span>
                    }
                    else
                    {
                        <span class="material-symbols-outlined" style="font-size: 18px;">delete</span>
                        <span>Delete</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

@if (showApproveGuarantorModal && approvingGuarantorId.HasValue)
{
    var guarantorToApprove = application?.Guarantors.FirstOrDefault(g => g.Id == approvingGuarantorId.Value);
    <div class="modal-backdrop show" @onclick="CloseApproveGuarantorModal">
        <div class="modal" style="max-width: 450px;" @onclick:stopPropagation>
            <div class="modal-header">
                <h3 class="modal-title">
                    <span class="material-symbols-outlined" style="font-size: 22px; vertical-align: middle; margin-right: var(--space-2); color: var(--success-600);">check_circle</span>
                    Approve Guarantor
                </h3>
                <button class="modal-close" @onclick="CloseApproveGuarantorModal">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to approve <strong>@(guarantorToApprove?.Name ?? "this guarantor")</strong>?</p>
                <p class="text-muted" style="font-size: var(--text-sm);">Once approved, the guarantor will be accepted as collateral support for this loan application.</p>
                @if (!string.IsNullOrEmpty(approveGuarantorError))
                {
                    <div class="alert alert-danger mt-3" style="display: flex; gap: var(--space-2); align-items: flex-start;">
                        <span class="material-symbols-outlined" style="color: var(--danger-600); font-size: 18px;">error</span>
                        <span>@approveGuarantorError</span>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" @onclick="CloseApproveGuarantorModal" disabled="@isApprovingGuarantor">Cancel</button>
                <button type="button" class="btn btn-success" @onclick="ConfirmApproveGuarantor" disabled="@isApprovingGuarantor">
                    @if (isApprovingGuarantor)
                    {
                        <span class="material-symbols-outlined spinning" style="font-size: 18px;">sync</span>
                        <span>Approving...</span>
                    }
                    else
                    {
                        <span class="material-symbols-outlined" style="font-size: 18px;">check_circle</span>
                        <span>Approve Guarantor</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

@if (showRejectGuarantorModal && rejectingGuarantorId.HasValue)
{
    var guarantorToReject = application?.Guarantors.FirstOrDefault(g => g.Id == rejectingGuarantorId.Value);
    <div class="modal-backdrop show" @onclick="CloseRejectGuarantorModal">
        <div class="modal" style="max-width: 480px;" @onclick:stopPropagation>
            <div class="modal-header">
                <h3 class="modal-title" style="color: var(--danger-600);">
                    <span class="material-symbols-outlined" style="font-size: 22px; vertical-align: middle; margin-right: var(--space-2);">cancel</span>
                    Reject Guarantor
                </h3>
                <button class="modal-close" @onclick="CloseRejectGuarantorModal">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: var(--space-4);">
                    Rejecting: <strong>@(guarantorToReject?.Name ?? "this guarantor")</strong>
                </p>
                <div class="form-group">
                    <label class="form-label">Rejection Reason *</label>
                    <textarea class="form-control" rows="3" @bind="rejectGuarantorReason"
                        placeholder="Explain why this guarantor is being rejected..."></textarea>
                </div>
                @if (!string.IsNullOrEmpty(rejectGuarantorError))
                {
                    <div class="alert alert-danger mt-3" style="display: flex; gap: var(--space-2); align-items: flex-start;">
                        <span class="material-symbols-outlined" style="color: var(--danger-600); font-size: 18px;">error</span>
                        <span>@rejectGuarantorError</span>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" @onclick="CloseRejectGuarantorModal" disabled="@isRejectingGuarantor">Cancel</button>
                <button type="button" class="btn btn-danger" @onclick="ConfirmRejectGuarantor"
                    disabled="@(isRejectingGuarantor || string.IsNullOrWhiteSpace(rejectGuarantorReason))">
                    @if (isRejectingGuarantor)
                    {
                        <span class="material-symbols-outlined spinning" style="font-size: 18px;">sync</span>
                        <span>Rejecting...</span>
                    }
                    else
                    {
                        <span class="material-symbols-outlined" style="font-size: 18px;">cancel</span>
                        <span>Reject Guarantor</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

@if (showDocumentModal)
{
    <UploadDocumentModal
        ApplicationId="Id"
        OnClose="CloseDocumentModal"
        OnSuccess="OnDocumentUploaded" />
}

@if (showRejectDocumentModal && rejectingDocumentId.HasValue)
{
    var docToReject = application?.Documents.FirstOrDefault(d => d.Id == rejectingDocumentId.Value);
    <div class="modal-backdrop show" @onclick="CloseRejectDocumentModal">
        <div class="modal" style="max-width: 480px;" @onclick:stopPropagation>
            <div class="modal-header">
                <h3 class="modal-title" style="color: var(--danger-600);">
                    <span class="material-symbols-outlined" style="font-size: 22px; vertical-align: middle; margin-right: var(--space-2);">cancel</span>
                    Reject Document
                </h3>
                <button class="modal-close" @onclick="CloseRejectDocumentModal">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: var(--space-4);">
                    Rejecting: <strong>@(docToReject?.Name ?? "this document")</strong>
                </p>
                <div class="form-group">
                    <label class="form-label">Rejection Reason *</label>
                    <textarea class="form-control" rows="3" @bind="rejectDocumentReason"
                        placeholder="Explain why this document is being rejected..."></textarea>
                </div>
                @if (!string.IsNullOrEmpty(rejectDocumentError))
                {
                    <div class="alert alert-danger mt-3" style="display: flex; gap: var(--space-2); align-items: flex-start;">
                        <span class="material-symbols-outlined" style="color: var(--danger-600); font-size: 18px;">error</span>
                        <span>@rejectDocumentError</span>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" @onclick="CloseRejectDocumentModal" disabled="@isProcessingDocument">Cancel</button>
                <button type="button" class="btn btn-danger" @onclick="ConfirmRejectDocument"
                    disabled="@(isProcessingDocument || string.IsNullOrWhiteSpace(rejectDocumentReason))">
                    @if (isProcessingDocument)
                    {
                        <span class="material-symbols-outlined spinning" style="font-size: 18px;">sync</span>
                        <span>Rejecting...</span>
                    }
                    else
                    {
                        <span class="material-symbols-outlined" style="font-size: 18px;">cancel</span>
                        <span>Reject Document</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

@if (showFinancialStatementModal)
{
    <CRMS.Web.Intranet.Components.Pages.Applications.Modals.FinancialStatementModal
        ApplicationId="Id"
        EditStatementId="editingStatementId"
        OnClose="CloseFinancialStatementModal"
        OnSuccess="OnFinancialStatementSaved" />
}

@if (showExcelUploadModal)
{
    <CRMS.Web.Intranet.Components.Pages.Applications.Modals.UploadFinancialStatementModal
        ApplicationId="Id"
        OnClose="CloseExcelUploadModal"
        OnImported="OnExcelImported" />
}

@if (showStatementViewModal && viewingStatementId.HasValue)
{
    var stmt = application?.FinancialStatements.FirstOrDefault(s => s.Id == viewingStatementId.Value);
    if (stmt != null)
    {
        <div class="modal-backdrop show" @onclick="CloseStatementViewModal">
            <div class="modal" style="max-width: 600px;" @onclick:stopPropagation>
                <div class="modal-header">
                    <h3 class="modal-title">Financial Statement - @stmt.Year</h3>
                    <button class="modal-close" @onclick="CloseStatementViewModal">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <div class="text-muted" style="font-size: var(--text-sm);">Year End Date</div>
                            <div style="font-weight: 500;">@stmt.YearEndDate.ToString("MMM dd, yyyy")</div>
                        </div>
                        <div>
                            <div class="text-muted" style="font-size: var(--text-sm);">Type</div>
                            <div><span class="badge badge-primary">@stmt.YearType</span></div>
                        </div>
                        <div>
                            <div class="text-muted" style="font-size: var(--text-sm);">Status</div>
                            <div><span class="badge badge-success">@stmt.Status</span></div>
                        </div>
                    </div>
                    
                    <h4 style="margin-bottom: var(--space-3); padding-bottom: var(--space-2); border-bottom: 1px solid var(--gray-200);">Balance Sheet Summary</h4>
                    <table class="table mb-4">
                        <tbody>
                            <tr>
                                <td>Total Assets</td>
                                <td style="text-align: right; font-weight: 500;">₦@stmt.TotalAssets.ToString("N0")</td>
                            </tr>
                            <tr>
                                <td>Total Liabilities</td>
                                <td style="text-align: right; font-weight: 500;">₦@stmt.TotalLiabilities.ToString("N0")</td>
                            </tr>
                            <tr>
                                <td>Total Equity</td>
                                <td style="text-align: right; font-weight: 500;">₦@stmt.TotalEquity.ToString("N0")</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <h4 style="margin-bottom: var(--space-3); padding-bottom: var(--space-2); border-bottom: 1px solid var(--gray-200);">Income Statement Summary</h4>
                    <table class="table">
                        <tbody>
                            <tr>
                                <td>Revenue</td>
                                <td style="text-align: right; font-weight: 500;">₦@stmt.Revenue.ToString("N0")</td>
                            </tr>
                            <tr>
                                <td>Net Profit</td>
                                <td style="text-align: right; font-weight: 500; color: @(stmt.NetProfit >= 0 ? "var(--success-600)" : "var(--danger-600)");">₦@stmt.NetProfit.ToString("N0")</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseStatementViewModal">Close</button>
                </div>
            </div>
        </div>
    }
}

@if (showDeleteConfirmModal && deletingStatementId.HasValue)
{
    var stmtToDelete = application?.FinancialStatements.FirstOrDefault(s => s.Id == deletingStatementId.Value);
    <div class="modal-backdrop show" @onclick="CloseDeleteConfirmModal">
        <div class="modal" style="max-width: 450px;" @onclick:stopPropagation>
            <div class="modal-header">
                <h3 class="modal-title" style="color: var(--danger-600);">
                    <span class="material-symbols-outlined" style="font-size: 24px; vertical-align: middle; margin-right: var(--space-2);">warning</span>
                    Delete Financial Statement
                </h3>
                <button class="modal-close" @onclick="CloseDeleteConfirmModal">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the financial statement for <strong>@stmtToDelete?.Year</strong>?</p>
                <p class="text-muted" style="font-size: var(--text-sm);">This will permanently remove the Balance Sheet, Income Statement, and Cash Flow data for this year. This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" @onclick="CloseDeleteConfirmModal" disabled="@isDeleting">Cancel</button>
                <button type="button" class="btn btn-danger" @onclick="ConfirmDeleteStatement" disabled="@isDeleting">
                    @if (isDeleting)
                    {
                        <span class="material-symbols-outlined spinning" style="font-size: 18px;">sync</span>
                        <span>Deleting...</span>
                    }
                    else
                    {
                        <span class="material-symbols-outlined" style="font-size: 18px;">delete</span>
                        <span>Delete</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

@if (showDeleteAllConfirmModal)
{
    <div class="modal-backdrop show" @onclick="CloseDeleteAllConfirmModal">
        <div class="modal" style="max-width: 450px;" @onclick:stopPropagation>
            <div class="modal-header">
                <h3 class="modal-title" style="color: var(--danger-600);">
                    <span class="material-symbols-outlined" style="font-size: 24px; vertical-align: middle; margin-right: var(--space-2);">warning</span>
                    Delete All Financial Statements
                </h3>
                <button class="modal-close" @onclick="CloseDeleteAllConfirmModal">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong>all @(application?.FinancialStatements.Count ?? 0) financial statement(s)</strong> for this application?</p>
                <p class="text-muted" style="font-size: var(--text-sm);">This will permanently remove all Balance Sheet, Income Statement, and Cash Flow data. This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" @onclick="CloseDeleteAllConfirmModal" disabled="@isDeleting">Cancel</button>
                <button type="button" class="btn btn-danger" @onclick="ConfirmDeleteAllStatements" disabled="@isDeleting">
                    @if (isDeleting)
                    {
                        <span class="material-symbols-outlined spinning" style="font-size: 18px;">sync</span>
                        <span>Deleting...</span>
                    }
                    else
                    {
                        <span class="material-symbols-outlined" style="font-size: 18px;">delete_sweep</span>
                        <span>Delete All</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

@if (showSubmitReviewModal)
{
    <div class="modal-backdrop show" @onclick="CloseSubmitReviewModal">
        <div class="modal" style="max-width: 500px;" @onclick:stopPropagation>
            <div class="modal-header">
                <h3 class="modal-title">Submit for Review</h3>
                <button class="modal-close" @onclick="CloseSubmitReviewModal">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                @if (validationErrors.Any())
                {
                    <div class="alert alert-warning mb-4">
                        <div style="font-weight: 600; margin-bottom: var(--space-2);">
                            <span class="material-symbols-outlined" style="font-size: 18px; vertical-align: middle;">warning</span>
                            Please complete the following before submitting:
                        </div>
                        <ul style="margin: 0; padding-left: var(--space-4);">
                            @foreach (var error in validationErrors)
                            {
                                <li>@error</li>
                            }
                        </ul>
                    </div>
                }
                else
                {
                    <div class="alert alert-info mb-4">
                        <span class="material-symbols-outlined" style="font-size: 18px; vertical-align: middle;">info</span>
                        This application will be submitted to Branch Review for approval.
                    </div>
                }
                
                <div class="form-group">
                    <label class="form-label">Comments (Optional)</label>
                    <textarea class="form-control" rows="3" @bind="submitComments" 
                        placeholder="Add any notes for the reviewer..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseSubmitReviewModal">Cancel</button>
                <button class="btn btn-primary" @onclick="SubmitForReview" disabled="@(validationErrors.Any() || isSubmittingForReview)">
                    @if (isSubmittingForReview)
                    {
                        <span class="spinner"></span>
                    }
                    Submit for Review
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public Guid Id { get; set; }

    private LoanApplicationDetail? application;
    private string activeTab = "overview";
    private bool isLoading = true;
    private bool isGeneratingPack;

    private bool showActionModal;
    private ActionType currentAction;
    private string actionComments = string.Empty;
    private bool isExecutingAction;

    // Data entry modals
    private bool showCollateralModal;
    private bool showViewCollateralModal;
    private bool showEditCollateralModal;
    private bool showDeleteCollateralModal;
    private Guid? viewingCollateralId;
    private Guid? editingCollateralId;
    private Guid? deletingCollateralId;

    private bool showGuarantorModal;
    private bool showViewGuarantorModal;
    private bool showEditGuarantorModal;
    private bool showDeleteGuarantorModal;
    private Guid? viewingGuarantorId;
    private Guid? editingGuarantorId;
    private Guid? deletingGuarantorId;

    private string? deleteErrorMessage;

    private bool showDocumentModal;
    private bool showFinancialStatementModal;
    private bool showExcelUploadModal;

    // Submit for review
    private bool showSubmitReviewModal;
    private bool isSubmittingForReview;
    private string submitComments = string.Empty;
    private List<string> validationErrors = [];

    private enum ActionType { Approve, Return, Reject }

    protected override async Task OnInitializedAsync()
    {
        await LoadApplication();
    }

    private async Task LoadApplication()
    {
        isLoading = true;
        application = await AppService.GetApplicationDetailAsync(Id);
        
        // Mock data for demo
        if (application == null)
        {
            application = GenerateMockApplication();
        }
        
        isLoading = false;
    }

    private void GoBack() => Navigation.NavigateTo("/applications");

    private bool CanGeneratePack => application?.Status is "Approved" or "CommitteeApproved" or "Disbursed";
    
    // Application is editable only in Draft status
    private bool IsApplicationEditable => application?.Status == "Draft";
    
    // Show Submit for Review button only for Draft applications owned by current user (Loan Officer)
    private bool ShowSubmitForReviewButton => application?.Status == "Draft" && 
        (AuthService.CurrentUser?.HasRole("LoanOfficer") ?? false);
    
    private bool ShowApproveButton => application?.Status switch
    {
        "BranchReview" => AuthService.CurrentUser?.HasRole("BranchApprover") ?? false,
        "HOReview" => AuthService.CurrentUser?.HasRole("HOReviewer") ?? false,
        "FinalApproval" => AuthService.CurrentUser?.HasRole("FinalApprover") ?? false,
        _ => false
    };

    private bool ShowReturnButton => application?.Status switch
    {
        "BranchReview" or "HOReview" or "CreditAnalysis" => true,
        _ => false
    };

    private bool ShowRejectButton => application?.Status switch
    {
        "BranchReview" or "HOReview" or "FinalApproval" => true,
        _ => false
    };

    private void ShowActionModal(ActionType action)
    {
        currentAction = action;
        actionComments = string.Empty;
        showActionModal = true;
    }

    private void CloseActionModal()
    {
        showActionModal = false;
        actionComments = string.Empty;
    }

    private string GetActionTitle() => currentAction switch
    {
        ActionType.Approve => "Approve Application",
        ActionType.Return => "Return for Correction",
        ActionType.Reject => "Reject Application",
        _ => "Action"
    };

    private string GetActionButtonClass() => currentAction switch
    {
        ActionType.Approve => "btn-success",
        ActionType.Return => "btn-warning",
        ActionType.Reject => "btn-danger",
        _ => "btn-primary"
    };

    private string GetActionButtonText() => currentAction switch
    {
        ActionType.Approve => "Confirm Approval",
        ActionType.Return => "Return Application",
        ActionType.Reject => "Confirm Rejection",
        _ => "Submit"
    };

    private async Task ExecuteAction()
    {
        if (currentAction != ActionType.Approve && string.IsNullOrWhiteSpace(actionComments))
        {
            return;
        }

        isExecutingAction = true;
        
        var userId = AuthService.CurrentUser?.Id ?? Guid.Empty;
        var userRole = AuthService.CurrentUser?.Roles.FirstOrDefault() ?? "User";
        
        ApiResponse result = currentAction switch
        {
            ActionType.Approve => await AppService.ApproveApplicationAsync(Id, actionComments, userId, userRole),
            ActionType.Return => await AppService.ReturnApplicationAsync(Id, actionComments, userId, userRole),
            ActionType.Reject => await AppService.RejectApplicationAsync(Id, actionComments, userId, userRole),
            _ => ApiResponse.Fail("Unknown action")
        };

        isExecutingAction = false;
        
        if (result.Success)
        {
            CloseActionModal();
            await LoadApplication();
        }
    }

    private async Task GenerateLoanPack()
    {
        isGeneratingPack = true;
        var userId = AuthService.CurrentUser?.Id ?? Guid.Empty;
        var userName = AuthService.CurrentUser?.FullName ?? "System";
        var result = await AppService.GenerateLoanPackAsync(Id, userId, userName);
        isGeneratingPack = false;
        
        if (result.Success && result.Data != null)
        {
            // For now, show success message - actual file download would need storage retrieval
            await JS.InvokeVoidAsync("alert", $"Loan pack generated: {result.Data.FileName}");
        }
    }

    private async Task RequestBureauCheck(Guid partyId)
    {
        // Bureau check requires consent record - simplified for now
        await LoadApplication();
    }

    private async Task GenerateAdvisory()
    {
        var userId = AuthService.CurrentUser?.Id ?? Guid.Empty;
        await AppService.GenerateAdvisoryAsync(Id, userId);
        await LoadApplication();
    }

    private async Task CastVote((string vote, string? comments) args)
    {
        if (application?.Committee != null)
        {
            var userId = AuthService.CurrentUser?.Id ?? Guid.Empty;
            await AppService.CastVoteAsync(application.Committee.ReviewId, args.vote, args.comments, userId);
            await LoadApplication();
        }
    }

    private async Task AddComment(string content)
    {
        // Comment functionality would need its own handler
        await LoadApplication();
    }

    // Modal handlers - Collateral
    private void ShowAddCollateralModal() => showCollateralModal = true;
    private void CloseCollateralModal() => showCollateralModal = false;
    private async Task OnCollateralAdded()
    {
        showCollateralModal = false;
        await LoadApplication();
    }

    private void ViewCollateral(Guid collateralId)
    {
        viewingCollateralId = collateralId;
        showViewCollateralModal = true;
    }

    private void CloseViewCollateralModal()
    {
        showViewCollateralModal = false;
        viewingCollateralId = null;
    }

    private async Task OnCollateralDocumentDeleted()
    {
        await LoadApplication();
    }

    private void EditCollateral(Guid collateralId)
    {
        editingCollateralId = collateralId;
        showEditCollateralModal = true;
    }

    private void CloseEditCollateralModal()
    {
        showEditCollateralModal = false;
        editingCollateralId = null;
    }

    private async Task OnCollateralUpdated()
    {
        showEditCollateralModal = false;
        editingCollateralId = null;
        await LoadApplication();
    }

    private void DeleteCollateral(Guid collateralId)
    {
        deletingCollateralId = collateralId;
        showDeleteCollateralModal = true;
        deleteErrorMessage = null;
    }

    private void CloseDeleteCollateralModal()
    {
        showDeleteCollateralModal = false;
        deletingCollateralId = null;
        deleteErrorMessage = null;
    }

    private async Task ConfirmDeleteCollateral()
    {
        if (deletingCollateralId == null) return;

        isDeleting = true;
        deleteErrorMessage = null;
        try
        {
            var result = await AppService.DeleteCollateralAsync(deletingCollateralId.Value);
            if (result.Success)
            {
                showDeleteCollateralModal = false;
                deletingCollateralId = null;
                await LoadApplication();
            }
            else
            {
                deleteErrorMessage = result.Error ?? "Failed to delete collateral.";
            }
        }
        finally
        {
            isDeleting = false;
        }
    }

    // Collateral valuation / approve
    private bool showSetValuationModal;
    private bool showApproveCollateralModal;
    private Guid? valuatingCollateralId;
    private Guid? approvingCollateralId;
    private string? approveCollateralError;
    private bool isApprovingCollateral;

    private bool CanManageValuation => application?.Status is not (null or "Draft" or "Approved" or "CommitteeApproved" or "Rejected" or "Disbursed");

    private void ShowSetValuationModal(Guid collateralId)
    {
        valuatingCollateralId = collateralId;
        showSetValuationModal = true;
    }

    private void CloseSetValuationModal()
    {
        showSetValuationModal = false;
        valuatingCollateralId = null;
    }

    private async Task OnCollateralValuated()
    {
        showSetValuationModal = false;
        valuatingCollateralId = null;
        await LoadApplication();
    }

    private void ShowApproveCollateralModal(Guid collateralId)
    {
        approvingCollateralId = collateralId;
        approveCollateralError = null;
        showApproveCollateralModal = true;
    }

    private void CloseApproveCollateralModal()
    {
        showApproveCollateralModal = false;
        approvingCollateralId = null;
        approveCollateralError = null;
    }

    private async Task ConfirmApproveCollateral()
    {
        if (approvingCollateralId == null) return;

        isApprovingCollateral = true;
        approveCollateralError = null;
        try
        {
            var userId = AuthService.CurrentUser?.Id ?? Guid.Empty;
            var result = await AppService.ApproveCollateralAsync(approvingCollateralId.Value, userId);
            if (result.Success)
            {
                showApproveCollateralModal = false;
                approvingCollateralId = null;
                await LoadApplication();
            }
            else
            {
                approveCollateralError = result.Error ?? "Failed to approve collateral.";
            }
        }
        finally
        {
            isApprovingCollateral = false;
        }
    }

    // Collateral document upload
    private bool showUploadCollateralDocModal;
    private Guid? uploadingCollateralDocId;

    private void ShowUploadCollateralDocModal(Guid collateralId)
    {
        uploadingCollateralDocId = collateralId;
        showUploadCollateralDocModal = true;
    }

    private void CloseUploadCollateralDocModal()
    {
        showUploadCollateralDocModal = false;
        uploadingCollateralDocId = null;
    }

    private async Task OnCollateralDocUploaded()
    {
        showUploadCollateralDocModal = false;
        uploadingCollateralDocId = null;
        await LoadApplication();
    }

    // Modal handlers - Guarantor
    private void ShowAddGuarantorModal() => showGuarantorModal = true;
    private void CloseGuarantorModal() => showGuarantorModal = false;
    private async Task OnGuarantorAdded()
    {
        showGuarantorModal = false;
        await LoadApplication();
    }

    private void ViewGuarantor(Guid guarantorId)
    {
        viewingGuarantorId = guarantorId;
        showViewGuarantorModal = true;
    }

    private void CloseViewGuarantorModal()
    {
        showViewGuarantorModal = false;
        viewingGuarantorId = null;
    }

    private void EditGuarantor(Guid guarantorId)
    {
        editingGuarantorId = guarantorId;
        showEditGuarantorModal = true;
    }

    private void CloseEditGuarantorModal()
    {
        showEditGuarantorModal = false;
        editingGuarantorId = null;
    }

    private async Task OnGuarantorUpdated()
    {
        showEditGuarantorModal = false;
        editingGuarantorId = null;
        await LoadApplication();
    }

    private void DeleteGuarantor(Guid guarantorId)
    {
        deletingGuarantorId = guarantorId;
        showDeleteGuarantorModal = true;
        deleteErrorMessage = null;
    }

    private void CloseDeleteGuarantorModal()
    {
        showDeleteGuarantorModal = false;
        deletingGuarantorId = null;
        deleteErrorMessage = null;
    }

    private async Task ConfirmDeleteGuarantor()
    {
        if (deletingGuarantorId == null) return;

        isDeleting = true;
        deleteErrorMessage = null;
        try
        {
            var result = await AppService.DeleteGuarantorAsync(deletingGuarantorId.Value);
            if (result.Success)
            {
                showDeleteGuarantorModal = false;
                deletingGuarantorId = null;
                await LoadApplication();
            }
            else
            {
                deleteErrorMessage = result.Error ?? "Failed to delete guarantor.";
            }
        }
        finally
        {
            isDeleting = false;
        }
    }

    // Guarantor approve / reject
    private bool showApproveGuarantorModal;
    private bool showRejectGuarantorModal;
    private Guid? approvingGuarantorId;
    private Guid? rejectingGuarantorId;
    private string? approveGuarantorError;
    private string rejectGuarantorReason = string.Empty;
    private string? rejectGuarantorError;
    private bool isApprovingGuarantor;
    private bool isRejectingGuarantor;

    private bool CanManageGuarantors => application?.Status is not (null or "Draft" or "Approved" or "CommitteeApproved" or "Rejected" or "Disbursed");

    private void ShowApproveGuarantorModal(Guid guarantorId)
    {
        approvingGuarantorId = guarantorId;
        approveGuarantorError = null;
        showApproveGuarantorModal = true;
    }

    private void CloseApproveGuarantorModal()
    {
        showApproveGuarantorModal = false;
        approvingGuarantorId = null;
        approveGuarantorError = null;
    }

    private async Task ConfirmApproveGuarantor()
    {
        if (approvingGuarantorId == null) return;

        isApprovingGuarantor = true;
        approveGuarantorError = null;
        try
        {
            var userId = AuthService.CurrentUser?.Id ?? Guid.Empty;
            var result = await AppService.ApproveGuarantorAsync(approvingGuarantorId.Value, userId);
            if (result.Success)
            {
                showApproveGuarantorModal = false;
                approvingGuarantorId = null;
                await LoadApplication();
            }
            else
            {
                approveGuarantorError = result.Error ?? "Failed to approve guarantor.";
            }
        }
        finally
        {
            isApprovingGuarantor = false;
        }
    }

    private void ShowRejectGuarantorModal(Guid guarantorId)
    {
        rejectingGuarantorId = guarantorId;
        rejectGuarantorReason = string.Empty;
        rejectGuarantorError = null;
        showRejectGuarantorModal = true;
    }

    private void CloseRejectGuarantorModal()
    {
        showRejectGuarantorModal = false;
        rejectingGuarantorId = null;
        rejectGuarantorReason = string.Empty;
        rejectGuarantorError = null;
    }

    private async Task ConfirmRejectGuarantor()
    {
        if (rejectingGuarantorId == null || string.IsNullOrWhiteSpace(rejectGuarantorReason)) return;

        isRejectingGuarantor = true;
        rejectGuarantorError = null;
        try
        {
            var userId = AuthService.CurrentUser?.Id ?? Guid.Empty;
            var result = await AppService.RejectGuarantorAsync(rejectingGuarantorId.Value, userId, rejectGuarantorReason);
            if (result.Success)
            {
                showRejectGuarantorModal = false;
                rejectingGuarantorId = null;
                await LoadApplication();
            }
            else
            {
                rejectGuarantorError = result.Error ?? "Failed to reject guarantor.";
            }
        }
        finally
        {
            isRejectingGuarantor = false;
        }
    }

    private void ShowUploadDocumentModal() => showDocumentModal = true;
    private void CloseDocumentModal() => showDocumentModal = false;
    private async Task OnDocumentUploaded()
    {
        showDocumentModal = false;
        await LoadApplication();
    }

    // Document verify / reject
    private bool showRejectDocumentModal;
    private Guid? rejectingDocumentId;
    private string rejectDocumentReason = string.Empty;
    private string? rejectDocumentError;
    private bool isProcessingDocument;

    private async Task VerifyDocument(Guid documentId)
    {
        isProcessingDocument = true;
        var userId = AuthService.CurrentUser?.Id ?? Guid.Empty;
        var result = await AppService.VerifyDocumentAsync(Id, documentId, userId);
        isProcessingDocument = false;

        if (result.Success)
        {
            await LoadApplication();
        }
    }

    private void ShowRejectDocumentModal(Guid documentId)
    {
        rejectingDocumentId = documentId;
        rejectDocumentReason = string.Empty;
        rejectDocumentError = null;
        showRejectDocumentModal = true;
    }

    private void CloseRejectDocumentModal()
    {
        showRejectDocumentModal = false;
        rejectingDocumentId = null;
        rejectDocumentReason = string.Empty;
        rejectDocumentError = null;
    }

    private async Task ConfirmRejectDocument()
    {
        if (rejectingDocumentId == null || string.IsNullOrWhiteSpace(rejectDocumentReason)) return;

        isProcessingDocument = true;
        rejectDocumentError = null;
        try
        {
            var userId = AuthService.CurrentUser?.Id ?? Guid.Empty;
            var result = await AppService.RejectDocumentAsync(Id, rejectingDocumentId.Value, userId, rejectDocumentReason);
            if (result.Success)
            {
                showRejectDocumentModal = false;
                rejectingDocumentId = null;
                await LoadApplication();
            }
            else
            {
                rejectDocumentError = result.Error ?? "Failed to reject document.";
            }
        }
        finally
        {
            isProcessingDocument = false;
        }
    }

    private void ShowFinancialStatementModal()
    {
        editingStatementId = null; // Ensure we're in create mode
        showFinancialStatementModal = true;
    }
    
    private void CloseFinancialStatementModal()
    {
        showFinancialStatementModal = false;
        editingStatementId = null;
    }
    
    private async Task OnFinancialStatementSaved()
    {
        showFinancialStatementModal = false;
        editingStatementId = null;
        await LoadApplication();
    }

    private void ShowExcelUploadModal() => showExcelUploadModal = true;
    private void CloseExcelUploadModal() => showExcelUploadModal = false;
    private async Task OnExcelImported()
    {
        showExcelUploadModal = false;
        await LoadApplication();
    }

    // Financial Statement View/Edit/Delete handlers
    private Guid? viewingStatementId;
    private Guid? editingStatementId;
    private bool showStatementViewModal;
    private bool showDeleteConfirmModal;
    private Guid? deletingStatementId;
    private bool showDeleteAllConfirmModal;
    private bool isDeleting;
    
    private void ViewFinancialStatement(Guid statementId)
    {
        viewingStatementId = statementId;
        showStatementViewModal = true;
    }
    
    private void EditFinancialStatement(Guid statementId)
    {
        editingStatementId = statementId;
        showFinancialStatementModal = true; // Reuse the same modal in edit mode
    }
    
    private void CloseStatementViewModal()
    {
        showStatementViewModal = false;
        viewingStatementId = null;
    }
    
    private void DeleteFinancialStatement(Guid statementId)
    {
        deletingStatementId = statementId;
        showDeleteConfirmModal = true;
    }
    
    private void CloseDeleteConfirmModal()
    {
        showDeleteConfirmModal = false;
        deletingStatementId = null;
    }
    
    private async Task ConfirmDeleteStatement()
    {
        if (deletingStatementId == null) return;
        
        isDeleting = true;
        try
        {
            var result = await AppService.DeleteFinancialStatementAsync(deletingStatementId.Value);
            if (result.Success)
            {
                showDeleteConfirmModal = false;
                deletingStatementId = null;
                await LoadApplication();
            }
        }
        finally
        {
            isDeleting = false;
        }
    }
    
    private void DeleteAllFinancialStatements()
    {
        showDeleteAllConfirmModal = true;
    }
    
    private void CloseDeleteAllConfirmModal()
    {
        showDeleteAllConfirmModal = false;
    }
    
    private async Task ConfirmDeleteAllStatements()
    {
        isDeleting = true;
        try
        {
            var result = await AppService.DeleteAllFinancialStatementsAsync(Id);
            if (result.Success)
            {
                showDeleteAllConfirmModal = false;
                await LoadApplication();
            }
        }
        finally
        {
            isDeleting = false;
        }
    }

    // Submit for Review handlers
    private void ShowSubmitForReviewModal()
    {
        // Validate required data
        validationErrors = ValidateForSubmission();
        submitComments = string.Empty;
        showSubmitReviewModal = true;
    }

    private void CloseSubmitReviewModal()
    {
        showSubmitReviewModal = false;
        submitComments = string.Empty;
    }

    private List<string> ValidateForSubmission()
    {
        var errors = new List<string>();
        
        if (application == null) return errors;

        // Check for required documents
        if (!application.Documents.Any())
        {
            errors.Add("At least one document must be uploaded");
        }
        else
        {
            var hasBankStatement = application.Documents.Any(d => d.Category == "BankStatement");
            if (!hasBankStatement)
                errors.Add("Bank statement is required");
        }

        // Check for directors/signatories
        if (!application.Directors.Any() && !application.Signatories.Any())
        {
            errors.Add("Directors or signatories information is required");
        }

        // Validate financial statements based on business age
        var fsValidation = ValidateFinancialStatements();
        if (!fsValidation.IsValid)
        {
            errors.Add(fsValidation.Message);
        }

        return errors;
    }

    private (bool IsValid, string Message) ValidateFinancialStatements()
    {
        if (application == null)
            return (false, "Application not loaded");

        var statements = application.FinancialStatements;
        var incorporationDate = application.Customer.IncorporationDate;
        
        // Calculate years in operation
        int yearsInOperation = incorporationDate.HasValue 
            ? (int)Math.Floor((DateTime.Now - incorporationDate.Value).TotalDays / 365.25)
            : 99; // Default to established business if unknown

        var audited = statements.Count(s => s.YearType == "Audited");
        var management = statements.Count(s => s.YearType == "ManagementAccounts");
        var projected = statements.Count(s => s.YearType == "Projected");
        var total = statements.Count;

        // Always need 3 years total
        if (total < 3)
        {
            return (false, $"Financial Statements: {total} year(s) entered, minimum 3 required");
        }

        // Startup: Need 3 projected
        if (yearsInOperation == 0)
        {
            if (projected >= 3) return (true, "");
            return (false, $"Startups require 3 years of projected financials ({projected} provided)");
        }
        
        // 1 year old: Need 1 actual + 2 projected
        if (yearsInOperation == 1)
        {
            if (audited + management >= 1 && projected >= 2) return (true, "");
            return (false, $"Businesses under 2 years need 1 year actuals + 2 years projected");
        }
        
        // 2 years old: Need 2 actuals (1 audited) + 1 projected
        if (yearsInOperation == 2)
        {
            if (audited >= 1 && (audited + management) >= 2 && projected >= 1) return (true, "");
            return (false, $"Businesses 2-3 years need 2 years actuals (1 audited) + 1 projected");
        }
        
        // 3+ years: Need 3 audited
        if (audited >= 3) return (true, "");
        return (false, $"Established businesses require 3 years of audited financials ({audited} provided)");
    }

    private async Task SubmitForReview()
    {
        if (validationErrors.Any()) return;

        isSubmittingForReview = true;

        try
        {
            var userId = AuthService.CurrentUser?.Id ?? Guid.Empty;
            var result = await AppService.SubmitApplicationAsync(Id, userId);

            if (result.Success)
            {
                showSubmitReviewModal = false;
                await LoadApplication();
            }
        }
        finally
        {
            isSubmittingForReview = false;
        }
    }

    private static string FormatStatus(string status) => status switch
    {
        "BranchReview" => "Branch Review",
        "HOReview" => "HO Review",
        "CommitteeCirculation" => "Committee Review",
        "CreditAnalysis" => "Credit Analysis",
        _ => status
    };

    private static string GetStatusBadgeClass(string status) => status switch
    {
        "Draft" => "badge-gray",
        "Approved" or "Disbursed" => "badge-success",
        "Rejected" => "badge-danger",
        _ => "badge-primary"
    };

    private static string FormatCurrency(decimal amount) => $"₦{amount:N0}";

    private LoanApplicationDetail GenerateMockApplication() => new()
    {
        Id = Id,
        ApplicationNumber = "CL-2026-0156",
        Status = "HOReview",
        Customer = new()
        {
            AccountNumber = "0012345678",
            CompanyName = "Acme Corporation Limited",
            RegistrationNumber = "RC123456",
            Industry = "Manufacturing",
            IncorporationDate = new DateTime(2010, 5, 15),
            Address = "123 Industrial Estate, Lagos",
            Email = "info@acmecorp.com",
            Phone = "+234 1 234 5678"
        },
        Loan = new()
        {
            ProductName = "Corporate Term Loan",
            RequestedAmount = 250_000_000m,
            InterestRate = 18.5m,
            InterestRateType = "Per Annum",
            TenorMonths = 36,
            Purpose = "Working capital and equipment purchase"
        },
        Directors =
        [
            new() { Id = Guid.NewGuid(), Name = "John Adebayo", BvnMasked = "****1234", Position = "Managing Director", ShareholdingPercentage = 35, HasBureauReport = true, BureauStatus = "Good" },
            new() { Id = Guid.NewGuid(), Name = "Sarah Okonkwo", BvnMasked = "****5678", Position = "Executive Director", ShareholdingPercentage = 25, HasBureauReport = true, BureauStatus = "Fair" },
            new() { Id = Guid.NewGuid(), Name = "Michael Eze", BvnMasked = "****9012", Position = "Non-Executive Director", ShareholdingPercentage = 20, HasBureauReport = false }
        ],
        Signatories =
        [
            new() { Id = Guid.NewGuid(), Name = "John Adebayo", BvnMasked = "****1234", MandateType = "A", HasBureauReport = true },
            new() { Id = Guid.NewGuid(), Name = "Sarah Okonkwo", BvnMasked = "****5678", MandateType = "A", HasBureauReport = true }
        ],
        Documents =
        [
            new() { Id = Guid.NewGuid(), Name = "Audited Financials 2025", Category = "AuditedFinancials", Status = "Verified", UploadedAt = DateTime.Now.AddDays(-5), SizeBytes = 2_500_000 },
            new() { Id = Guid.NewGuid(), Name = "Board Resolution", Category = "BoardResolution", Status = "Verified", UploadedAt = DateTime.Now.AddDays(-5), SizeBytes = 500_000 },
            new() { Id = Guid.NewGuid(), Name = "Bank Statement - GTB", Category = "BankStatement", Status = "Pending", UploadedAt = DateTime.Now.AddDays(-3), SizeBytes = 1_200_000 }
        ],
        Collaterals =
        [
            new() { Id = Guid.NewGuid(), Type = "Property", Description = "Commercial property at Victoria Island", MarketValue = 500_000_000m, ForcedSaleValue = 350_000_000m, LoanToValue = 50m, Status = "Verified", LastValuationDate = DateTime.Now.AddMonths(-1) }
        ],
        Guarantors =
        [
            new() { Id = Guid.NewGuid(), Name = "Delta Holdings Ltd", Relationship = "Parent Company", GuaranteeAmount = 250_000_000m, Status = "Active", HasBureauReport = true }
        ],
        BureauReports =
        [
            new() { Id = Guid.NewGuid(), SubjectName = "John Adebayo", SubjectType = "Director", CreditScore = 720, Rating = "Good", ActiveLoans = 2, TotalExposure = 15_000_000m, DelinquencyCount = 0, HasLegalIssues = false, ReportDate = DateTime.Now.AddDays(-3) },
            new() { Id = Guid.NewGuid(), SubjectName = "Sarah Okonkwo", SubjectType = "Director", CreditScore = 680, Rating = "Fair", ActiveLoans = 3, TotalExposure = 25_000_000m, DelinquencyCount = 1, HasLegalIssues = false, ReportDate = DateTime.Now.AddDays(-3) }
        ],
        Advisory = new()
        {
            OverallScore = 72.5m,
            RiskRating = "Medium",
            ScoreBreakdown =
            [
                new() { Category = "Financial Health", Score = 78, MaxScore = 100, Weight = 30 },
                new() { Category = "Credit History", Score = 70, MaxScore = 100, Weight = 25 },
                new() { Category = "Collateral Coverage", Score = 85, MaxScore = 100, Weight = 20 },
                new() { Category = "Industry Risk", Score = 65, MaxScore = 100, Weight = 15 },
                new() { Category = "Management Quality", Score = 68, MaxScore = 100, Weight = 10 }
            ],
            Recommendations = ["Consider reducing loan amount to ₦200M for better debt coverage", "Request additional collateral or guarantee"],
            RedFlags = ["One director has minor delinquency history", "Industry sector facing headwinds"],
            Strengths = ["Strong cash flow from operations", "Established customer with good banking history", "Adequate collateral coverage"],
            GeneratedAt = DateTime.Now.AddDays(-2)
        },
        WorkflowHistory =
        [
            new() { FromStage = "", ToStage = "Draft", Action = "Created", PerformedBy = "Michael Obi", Timestamp = DateTime.Now.AddDays(-7) },
            new() { FromStage = "Draft", ToStage = "Submitted", Action = "Submitted", PerformedBy = "Michael Obi", Timestamp = DateTime.Now.AddDays(-6) },
            new() { FromStage = "Submitted", ToStage = "BranchReview", Action = "Assigned", PerformedBy = "System", Timestamp = DateTime.Now.AddDays(-6) },
            new() { FromStage = "BranchReview", ToStage = "CreditAnalysis", Action = "Approved", PerformedBy = "John Adeyemi", Timestamp = DateTime.Now.AddDays(-4), Comments = "Good application, proceed" },
            new() { FromStage = "CreditAnalysis", ToStage = "HOReview", Action = "Completed", PerformedBy = "Credit Team", Timestamp = DateTime.Now.AddDays(-2) }
        ],
        Committee = new()
        {
            ReviewId = Guid.NewGuid(),
            CommitteeType = "Credit Committee",
            Status = "Pending",
            Members =
            [
                new() { UserId = Guid.NewGuid(), Name = "Dr. Amina Ibrahim", Role = "Chairperson" },
                new() { UserId = Guid.NewGuid(), Name = "Chief Risk Officer", Role = "Member", Vote = "Approve", VotedAt = DateTime.Now.AddHours(-5) },
                new() { UserId = Guid.NewGuid(), Name = "Head of Credit", Role = "Member" }
            ]
        },
        Comments =
        [
            new() { Id = Guid.NewGuid(), Author = "John Adeyemi", Content = "Customer has good track record. Recommend approval.", CreatedAt = DateTime.Now.AddDays(-4) },
            new() { Id = Guid.NewGuid(), Author = "Credit Team", Content = "Bureau checks completed. Minor concern on one director but overall acceptable.", CreatedAt = DateTime.Now.AddDays(-2) }
        ],
        CreatedAt = DateTime.Now.AddDays(-7),
        CreatedBy = "Michael Obi"
    };
}
