@using CRMS.Web.Intranet.Models
@inject ApplicationService AppService
@inject AuthService AuthService

<div class="modal-backdrop show" @onclick="Close">
    <div class="modal" style="max-width: 450px;" @onclick:stopPropagation>
        <div class="modal-header">
            <h3 class="modal-title">Complete Information — @Party?.Name</h3>
            <button type="button" class="modal-close" @onclick="Close">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="modal-body">
            <p class="text-muted" style="font-size: var(--text-sm); margin-bottom: var(--space-4);">
                Fill in the missing information that was not available from core banking.
            </p>

            @if (showBvn)
            {
                <div class="form-group">
                    <label class="form-label">BVN (Bank Verification Number)</label>
                    <input type="text" class="form-control" @bind="bvn" placeholder="11-digit BVN" maxlength="11" />
                    @if (bvn != null && bvn.Length > 0 && bvn.Length != 11)
                    {
                        <div class="form-error">BVN must be exactly 11 digits</div>
                    }
                </div>
            }

            @if (showShareholding)
            {
                <div class="form-group">
                    <label class="form-label">Shareholding % (0–100)</label>
                    <input type="number" class="form-control" @bind="shareholdingPercent" min="0" max="100" step="0.01" />
                </div>
            }

            @if (!string.IsNullOrEmpty(error))
            {
                <div class="alert alert-danger mt-3">
                    <span class="material-symbols-outlined" style="font-size: 18px; vertical-align: middle;">error</span>
                    @error
                </div>
            }
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" @onclick="Close" disabled="@isSaving">Cancel</button>
            <button type="button" class="btn btn-primary" @onclick="Save" disabled="@(!IsValid || isSaving)">
                @if (isSaving)
                {
                    <span class="spinner"></span>
                }
                Save
            </button>
        </div>
    </div>
</div>

@code {
    [Parameter] public Guid ApplicationId { get; set; }
    [Parameter] public PartyInfo? Party { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnSuccess { get; set; }

    private string? bvn;
    private decimal? shareholdingPercent;
    private bool isSaving;
    private string? error;

    private bool showBvn => string.IsNullOrEmpty(Party?.RawBVN);
    private bool showShareholding => Party?.ShareholdingPercentage == null && Party?.PartyType == "Director";

    private bool IsValid
    {
        get
        {
            if (showBvn && !string.IsNullOrEmpty(bvn) && bvn.Length != 11) return false;
            if (!showBvn && !showShareholding) return false;
            return true;
        }
    }

    private async Task Save()
    {
        isSaving = true;
        error = null;
        var userId = AuthService.CurrentUser?.Id ?? Guid.Empty;
        var result = await AppService.UpdatePartyInfoAsync(
            ApplicationId,
            Party!.Id,
            showBvn ? bvn : null,
            showShareholding ? shareholdingPercent : null,
            userId);
        isSaving = false;
        if (result.Success)
            await OnSuccess.InvokeAsync();
        else
            error = result.Error ?? "Failed to save.";
    }

    private Task Close() => OnClose.InvokeAsync();
}
