@inject ApplicationService AppService
@inject AuthService AuthService

<div class="modal-backdrop show" @onclick="Close">
    <div class="modal" style="max-width: 600px; max-height: 85vh; display: flex; flex-direction: column;" @onclick:stopPropagation>
        <div class="modal-header">
            <h3 class="modal-title">Add Collateral</h3>
            <button type="button" class="modal-close" @onclick="Close">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="modal-body" style="flex: 1; overflow-y: auto;">
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger mb-4">@errorMessage</div>
            }

            <div class="form-group">
                <label class="form-label">Collateral Type *</label>
                <select class="form-control" @bind="model.Type">
                    <option value="">Select type...</option>
                    <option value="RealEstate">Real Estate / Property</option>
                    <option value="Vehicle">Vehicle</option>
                    <option value="Equipment">Equipment</option>
                    <option value="Inventory">Inventory</option>
                    <option value="CashDeposit">Cash Deposit</option>
                    <option value="FixedDeposit">Fixed Deposit</option>
                    <option value="TreasuryBills">Treasury Bills</option>
                    <option value="Stocks">Stocks</option>
                    <option value="Bonds">Bonds</option>
                    <option value="Invoice">Invoice / Receivables</option>
                    <option value="ContractProceeds">Contract Proceeds</option>
                    <option value="InsurancePolicy">Insurance Policy</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Description *</label>
                <textarea class="form-control" rows="3" @bind="model.Description" 
                    placeholder="Describe the collateral in detail..."></textarea>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="form-group">
                    <label class="form-label">Asset Identifier</label>
                    <input type="text" class="form-control" @bind="model.AssetIdentifier" 
                        placeholder="e.g., Title deed number, VIN" />
                </div>
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <input type="text" class="form-control" @bind="model.Location" 
                        placeholder="Physical location of asset" />
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="form-group">
                    <label class="form-label">Owner Name</label>
                    <input type="text" class="form-control" @bind="model.OwnerName" 
                        placeholder="Legal owner of the asset" />
                </div>
                <div class="form-group">
                    <label class="form-label">Ownership Type</label>
                    <select class="form-control" @bind="model.OwnershipType">
                        <option value="">Select...</option>
                        <option value="Sole">Sole Ownership</option>
                        <option value="Joint">Joint Ownership</option>
                        <option value="Corporate">Corporate Ownership</option>
                        <option value="Leased">Leased</option>
                    </select>
                </div>
            </div>

            <hr style="margin: var(--space-4) 0;" />
            <h4 style="font-size: var(--text-sm); color: var(--gray-500); margin-bottom: var(--space-3);">VALUATION (Optional)</h4>

            <div class="grid grid-cols-2 gap-4">
                <div class="form-group">
                    <label class="form-label">Market Value (₦)</label>
                    <input type="number" class="form-control" @bind="model.MarketValue" min="0" step="0.01" />
                </div>
                <div class="form-group">
                    <label class="form-label">Forced Sale Value (₦)</label>
                    <input type="number" class="form-control" @bind="model.ForcedSaleValue" min="0" step="0.01" />
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Haircut Percentage (%)</label>
                <input type="number" class="form-control" @bind="model.HaircutPercentage" min="0" max="100" step="0.1" 
                    style="max-width: 150px;" />
                <div class="form-hint">Discount applied to market value for risk purposes</div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-outline" @onclick="Close" disabled="@isSubmitting">Cancel</button>
            <button type="button" class="btn btn-primary" @onclick="Submit" disabled="@(!IsValid || isSubmitting)">
                @if (isSubmitting)
                {
                    <span class="material-symbols-outlined spinning" style="font-size: 18px;">sync</span>
                }
                <span class="material-symbols-outlined" style="font-size: 18px;">add</span>
                <span>Add Collateral</span>
            </button>
        </div>
    </div>
</div>

<style>
    .spinning {
        animation: spin 1s linear infinite;
    }
    
    @@keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>

@code {
    [Parameter] public Guid ApplicationId { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnSuccess { get; set; }

    private CollateralModel model = new();
    private string? errorMessage;
    private bool isSubmitting;

    private bool IsValid => !string.IsNullOrWhiteSpace(model.Type) && !string.IsNullOrWhiteSpace(model.Description);

    private async Task Submit()
    {
        if (!IsValid) return;

        isSubmitting = true;
        errorMessage = null;

        try
        {
            var userId = AuthService.CurrentUser?.Id ?? Guid.Empty;
            var request = new AddCollateralRequest
            {
                LoanApplicationId = ApplicationId,
                Type = model.Type,
                Description = model.Description,
                AssetIdentifier = model.AssetIdentifier,
                Location = model.Location,
                OwnerName = model.OwnerName,
                OwnershipType = model.OwnershipType
            };

            var result = await AppService.AddCollateralAsync(request, userId);

            if (result.Success && result.Data != null)
            {
                // If valuation provided, set it
                if (model.MarketValue > 0)
                {
                    await AppService.SetCollateralValuationAsync(
                        result.Data.Id,
                        model.MarketValue,
                        model.ForcedSaleValue,
                        model.HaircutPercentage
                    );
                }

                await OnSuccess.InvokeAsync();
            }
            else
            {
                errorMessage = result.Error ?? "Failed to add collateral";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task Close() => await OnClose.InvokeAsync();

    private class CollateralModel
    {
        public string Type { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string? AssetIdentifier { get; set; }
        public string? Location { get; set; }
        public string? OwnerName { get; set; }
        public string? OwnershipType { get; set; }
        public decimal MarketValue { get; set; }
        public decimal? ForcedSaleValue { get; set; }
        public decimal? HaircutPercentage { get; set; }
    }
}
